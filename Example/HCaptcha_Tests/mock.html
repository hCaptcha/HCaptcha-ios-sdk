<html>
  <head>
    <meta name="viewport" content="width=device-width" />
    <script type="text/javascript">
      // onerror need to report errors which happens on WKWebView.loadHTMLString
      window.onerror = function(msg, url, line, column, error) {
        if (window.webkit) {
          window.webkit.messageHandlers.hcaptcha.postMessage({ "error": 1 });
        } else {
          console.log("Error:", error);
        }
      };
    </script>
    <script type="text/javascript">
      var key = "${apiKey}";
      var endpoint = "${endpoint}";
      var shouldFail = ${shouldFail};
      var rqdata = "${rqdata}";
      var theme = ${theme};
      var debugInfo = JSON.parse('${debugInfo}');

      const themeType = typeof theme;
      console.assert(themeType === "string" || themeType === "object", "invalid theme object");
      console.assert(Array.isArray(debugInfo), "invalid type");

      var post = function(value) {
          window.webkit.messageHandlers.hcaptcha.postMessage(value);
      };

      var token = null;

      var execute = function(verifyParams) {
          if (shouldFail) {
              post({error: 15}); // .sessionTimeout
          } else {
              // Validate verify params if provided
              if (verifyParams) {
                  var validationError = validateVerifyParams(verifyParams);
                  if (validationError) {
                      post({error: validationError});
                      return;
                  }

                  // Log verify params for testing
                  post({"log": "verifyParams: " + JSON.stringify(verifyParams)});
              }

              var messageToPost = ${message};
              if (rqdata) {
                  post({"log": rqdata});
              }
              if (messageToPost.action === "openExternalPage") {
                  document.getElementById("external-link").click();
              } else if (messageToPost.action === "sms") {
                  window.open("sms:+123-456-789?body=somebody-someone")
              }
              messageToPost.token = token || messageToPost.token;
              post(messageToPost);
              if (messageToPost && messageToPost.token || messageToPost.action === "showHCaptcha") {
                  setTimeout(function() {
                      post({ action: "onOpen" });
                  }, 100);
              }
          }
      };

      var validateVerifyParams = function(params) {
          try {
              // Check if params is an object
              if (typeof params !== 'object') {
                  post({"log": "bad object type"});
                  return 34; // verifyParamsParseError
              }

              // Validate phonePrefix if present
              if (params.mfa_phoneprefix !== undefined) {
                  if (typeof params.mfa_phoneprefix !== 'string') {
                      post({"log": "bad type mfa_phoneprefix"});
                      return 34; // verifyParamsParseError
                  }
                  // Basic validation: should be 1-4 digits, optionally with + prefix
                  var phonePrefixRegex = /^\+?[1-9]\d{0,3}$/;
                  if (!phonePrefixRegex.test(params.mfa_phoneprefix)) {
                      post({"log": "malformed mfa_phoneprefix"});
                      return 34; // verifyParamsParseError
                  }
              }

              // Validate phoneNumber if present
              if (params.mfa_phonenumber !== undefined) {
                  if (typeof params.mfa_phonenumber !== 'string') {
                      post({"log": "bad type mfa_phonenumber"});
                      return 34; // verifyParamsParseError
                  }
                  // Basic validation: should be 7-15 digits, optionally with + prefix
                  var phoneNumberRegex = /^\+?[1-9]\d{6,14}$/;
                  if (!phoneNumberRegex.test(params.mfa_phonenumber)) {
                      post({"log": "malformed mfa_phonenumber"});
                      return 34; // verifyParamsParseError
                  }
              }

              // Validate resetOnError if present
              if (params.resetOnError !== undefined && typeof params.resetOnError !== 'boolean') {
                  post({"log": "bad type resetOnError"});
                  return 34; // verifyParamsParseError
              }

              return null; // No validation errors
          } catch (e) {
              post({"log": "validateVerifyParams exception " + e.message});
              return 34; // verifyParamsParseError
          }
      };

      // Mock hcaptcha.setData to accept userJourney and immediately post a token
      var hcaptcha = {
          setData: function(containerId, data) {
              try {
                  if (data && data.userJourney) {
                      token = "journeys:setData";
                  }
              } catch (e) {
              }
          }
      };

      var reset = function() {
          shouldFail = false;
          post({ action: "didLoad" });
      };

      post({ action: "didLoad" });

      // clear global error handle, rest will be handled in WKWebView.evaluateJavaScript closure
      window.onerror = null;
    </script>
  </head>
  <body>
    <span id="submit" style="visibility: hidden;"></span>
    <a id="external-link" target="_blank" href="https://hcaptcha.com" rel="noopener">Test external</a>
  </body>
</html>
